<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üöú Tractor Time Logger + Multi Activity</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#047857">
<link rel="icon" href="icon-192.png">
<style>
/* ...same CSS as previous version... */
body {
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  margin: 20px;
  background: #f0fdf4;
}
h2 { color: #047857; }
button, select {
  padding: 10px 18px;
  margin: 5px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
}
#startBtn { background: #10b981; color: white; }
#stopBtn { background: #ef4444; color: white; }
#newActBtn { background: #3b82f6; color: white; }
#clearBtn { background: #f59e0b; color: white; }
#langSel { float: right; margin-top: -40px; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
}
th { background: #d1fae5; }
.summary-row td {
  background: #e0e7ff;
  font-weight: bold;
  text-align: left;
  border: none;
}
.hr-row td {
  border-top: 2px solid #111;
  border-bottom: none;
  border-left: none;
  border-right: none;
  padding: 0;
  height: 2px;
  background: none;
}
#summary { margin-top: 15px; font-size: 17px; }
</style>
</head>
<body>

<select id="langSel">
  <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
  <option value="en">üá¨üáß English</option>
</select>

<h2 id="mainHeading">üöú ‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§∞ ‡§µ‡§∞‡•ç‡§ï ‡§≤‡•â‡§ó‡§∞ + ‚Çπ25/‡§Æ‡§ø‡§®‡§ü</h2>

<button id="newActBtn"></button>
<button id="startBtn"></button>
<button id="stopBtn"></button>
<button id="clearBtn"></button>

<table id="logTable">
  <tr>
    <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
  </tr>
</table>

<div id="summary"></div>

<script>
// ----- PWA Service Worker Registration -----
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(function(reg) {
      console.log('Service Worker Registered!', reg);
    });
}

// ----- Translations -----
const translations = {
  hi: {
    mainHeading: "üöú ‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§∞ ‡§µ‡§∞‡•ç‡§ï ‡§≤‡•â‡§ó‡§∞ + ‚Çπ25/‡§Æ‡§ø‡§®‡§ü",
    newActivity: "‚ûï ‡§®‡§à ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡§ø‡§ü‡•Ä",
    start: "‚ñ∂ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
    stop: "‚èπ ‡§∞‡•ã‡§ï‡•á‡§Ç",
    clear: "üóë ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç",
    activity: "‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡§ø‡§ü‡•Ä",
    date: "‡§§‡§æ‡§∞‡•Ä‡§ñ",
    startTime: "‡§∂‡•Å‡§∞‡•Ç",
    stopTime: "‡§∞‡•ã‡§ï‡•á‡§Ç",
    totalTime: "‡§ï‡•Å‡§≤ ‡§∏‡§Æ‡§Ø",
    payment: "‡§™‡•á‡§Æ‡•á‡§Ç‡§ü (‚Çπ)",
    delete: "‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å",
    summaryRow: "‡§™‡§ø‡§õ‡§≤‡•Ä ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡§ø‡§ü‡•Ä ‡§ï‡§æ ‡§ï‡•Å‡§≤ ‡§∏‡§Æ‡§Ø: {H} ‡§ò‡§£‡•ç‡§ü‡§æ {M} ‡§Æ‡§ø‡§®‡§ü | Amount: ‚Çπ{P}",
    totalSummary: "‡§ï‡•Å‡§≤ ‡§∏‡§Æ‡§Ø: {H} ‡§ò‡§£‡•ç‡§ü‡§æ {M} ‡§Æ‡§ø‡§®‡§ü | ‡§ï‡•Å‡§≤ ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü: ‚Çπ{P}",
    pleaseCreate: "‡§™‡§π‡§≤‡•á ‡§®‡§à ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡§ø‡§ü‡•Ä ‡§¨‡§®‡§æ‡§è‡§Ç!",
    pleaseStop: "‡§™‡§π‡§≤‡•á Stop ‡§¶‡§¨‡§æ‡§è‡§Ç!",
    pleaseStart: "‡§™‡§π‡§≤‡•á Start ‡§¶‡§¨‡§æ‡§á‡§è!",
    entryDelQ: "‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡•á ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§Æ‡§ø‡§ü‡§æ‡§®‡•Ä ‡§π‡•à?",
    allDelQ: "‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§®‡§æ ‡§π‡•à?"
  },
  en: {
    mainHeading: "üöú Tractor Work Logger + ‚Çπ25/min",
    newActivity: "‚ûï New Activity",
    start: "‚ñ∂ Start",
    stop: "‚èπ Stop",
    clear: "üóë Clear Data",
    activity: "Activity",
    date: "Date",
    startTime: "Start",
    stopTime: "Stop",
    totalTime: "Total Time",
    payment: "Payment (‚Çπ)",
    delete: "Delete",
    summaryRow: "Previous Activity Total Time: {H} hour {M} minute | Amount: ‚Çπ{P}",
    totalSummary: "Total Time: {H} hour {M} minute | Total Payment: ‚Çπ{P}",
    pleaseCreate: "Please create a new Activity first!",
    pleaseStop: "Press Stop first!",
    pleaseStart: "Press Start first!",
    entryDelQ: "Delete this entry?",
    allDelQ: "Delete all data?"
  }
};

let selectedLang = localStorage.getItem("tractorLang") || "hi";
const RATE_PER_MIN = 25;
let data = JSON.parse(localStorage.getItem("tractorData") || "[]");
let startTime = null;
let currentActivity = data.length-1;
let currentRowIndex = null;

// --- On load: reload-safe startTime ---
window.onload = function() {
  renderTexts();
  const storedStart = localStorage.getItem("tractorStartTime");
  if(storedStart) {
    startTime = new Date(storedStart);
    let activityIdx = localStorage.getItem("tractorStartActivity");
    if(activityIdx !== null) currentActivity = parseInt(activityIdx);
    if(currentActivity!=null && data[currentActivity] && data[currentActivity].logs.length>0) {
      currentRowIndex = data[currentActivity].logs.length-1;
    }
    document.getElementById("startBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;
  } else {
    startTime = null;
    currentRowIndex = null;
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
  }
  loadLogs();
};

const table = document.getElementById("logTable");
const summaryDiv = document.getElementById("summary");

function t(key, vars) {
  let str = translations[selectedLang][key] || key;
  if(vars) for(let k in vars) str = str.replace(`{${k}}`, vars[k]);
  return str;
}
function autoActivityName() {
  return selectedLang === "hi" ? `‡§è‡§ï‡•ç‡§ü‡§ø‡§µ‡§ø‡§ü‡•Ä ${data.length + 1}` : `Activity ${data.length + 1}`;
}
function formatTime(d) {
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function renderTexts() {
  document.getElementById("mainHeading").innerText = t("mainHeading");
  document.getElementById("newActBtn").innerText = t("newActivity");
  document.getElementById("startBtn").innerText = t("start");
  document.getElementById("stopBtn").innerText = t("stop");
  document.getElementById("clearBtn").innerText = t("clear");
  renderTableHeadings();
}
function renderTableHeadings() {
  let ths = table.rows[0].cells;
  ths[0].innerText = t("activity");
  ths[1].innerText = t("date");
  ths[2].innerText = t("startTime");
  ths[3].innerText = t("stopTime");
  ths[4].innerText = t("totalTime");
  ths[5].innerText = t("payment");
  ths[6].innerText = t("delete");
}

function loadLogs() {
  renderTableHeadings();
  while(table.rows.length > 1) table.deleteRow(1);

  // ---- REVERSE ORDER LOOP ----
  for(let actIdx = data.length - 1; actIdx >= 0; actIdx--) {
    let act = data[actIdx];
    let actTotalMins = 0, actTotalPay = 0;
    act.logs.forEach((log, logIdx)=>{
      const row = table.insertRow();
      row.insertCell(0).innerText = act.activity;
      row.insertCell(1).innerText = log.date;
      row.insertCell(2).innerText = log.start;
      row.insertCell(3).innerText = log.stop || "";
      row.insertCell(4).innerText = log.total || "";
      row.insertCell(5).innerText = log.payment || "";
      let delCell = row.insertCell(6);
      let btn = document.createElement("button");
      btn.innerText = t("delete");
      btn.onclick = function() {
        if(confirm(t("entryDelQ"))) {
          act.logs.splice(logIdx,1);
          localStorage.setItem("tractorData", JSON.stringify(data));
          loadLogs();
        }
      };
      delCell.appendChild(btn);

      if(log.payment) {
        let mins = Math.ceil(log.payment/RATE_PER_MIN);
        actTotalMins += mins;
        actTotalPay += log.payment;
      }
    });
    if(act.logs.length>0) {
      let sumRow = table.insertRow();
      sumRow.className = "summary-row";
      let cell = sumRow.insertCell(0);
      cell.colSpan = 7;
      let hrs = Math.floor(actTotalMins/60);
      let mins = actTotalMins%60;
      let summaryRowText = t("summaryRow", {H:hrs, M:mins, P:actTotalPay});
      cell.innerHTML = summaryRowText;
    }
    let hrRow = table.insertRow();
    hrRow.className = "hr-row";
    let cell2 = hrRow.insertCell(0);
    cell2.colSpan = 7;
    cell2.innerHTML = "";
  }

  let totalMins = 0;
  let totalPay = 0;
  data.forEach(act=>{
    act.logs.forEach(log=>{
      if(log.payment) {
        let mins = Math.ceil(log.payment/RATE_PER_MIN);
        totalMins += mins;
        totalPay += log.payment;
      }
    });
  });
  let hrs = Math.floor(totalMins/60);
  let mins = totalMins%60;
  let summaryStr = t("totalSummary", {H:hrs, M:mins, P:totalPay});
  summaryDiv.innerText = summaryStr;
}

// --- New Activity ---
document.getElementById("newActBtn").onclick = ()=>{
  if(currentActivity!==null && startTime) finishActivity();
  data.push({activity: autoActivityName(), logs:[]});
  localStorage.setItem("tractorData", JSON.stringify(data));
  currentActivity = data.length-1;
  startTime = null;
  currentRowIndex = null;
  localStorage.removeItem("tractorStartTime");
  localStorage.removeItem("tractorStartActivity");
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
  loadLogs();
};

// --- Start Button ---
document.getElementById("startBtn").onclick = ()=>{
  if(currentActivity===null) return alert(t("pleaseCreate"));
  if(startTime) return alert(t("pleaseStop"));
  startTime = new Date();
  localStorage.setItem("tractorStartTime", startTime.toISOString());
  localStorage.setItem("tractorStartActivity", currentActivity);
  const log = {
    date: new Date().toLocaleDateString(selectedLang==="hi"?"hi-IN":"en-GB"),
    start: formatTime(startTime),
    stop: "",
    total: "",
    payment: ""
  };
  data[currentActivity].logs.push(log);
  currentRowIndex = data[currentActivity].logs.length-1;
  localStorage.setItem("tractorData", JSON.stringify(data));
  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
  loadLogs();
};

// --- Stop Button ---
document.getElementById("stopBtn").onclick = ()=>{
  if(currentActivity===null) return alert(t("pleaseCreate"));
  if(!startTime) return alert(t("pleaseStart"));
  finishActivity();
  localStorage.removeItem("tractorStartTime");
  localStorage.removeItem("tractorStartActivity");
  startTime = null;
  currentRowIndex = null;
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
  loadLogs();
};

function finishActivity() {
  const stopTime = new Date();
  const diffMs = stopTime - startTime;
  const totalMins = Math.ceil(diffMs/(1000*60));
  const hrs = Math.floor(totalMins/60);
  const mins = totalMins%60;
  let totalStr;
  if(selectedLang === "hi") {
    totalStr = `${hrs} ‡§ò‡§£‡•ç‡§ü‡§æ ${mins} ‡§Æ‡§ø‡§®‡§ü`;
  } else {
    totalStr = `${hrs} hour ${mins} minute`;
  }
  const payment = totalMins*RATE_PER_MIN;

  const log = data[currentActivity].logs[currentRowIndex];
  log.stop = formatTime(stopTime);
  log.total = totalStr;
  log.payment = payment;

  localStorage.setItem("tractorData", JSON.stringify(data));
}

// --- Clear Activity ---
document.getElementById("clearBtn").onclick = ()=>{
  if(currentActivity===null) return alert(t("pleaseCreate"));
  if(confirm(t("allDelQ"))) {
    data[currentActivity].logs = [];
    localStorage.setItem("tractorData", JSON.stringify(data));
    loadLogs();
  }
};

// --- Language Change ---
document.getElementById('langSel').value = selectedLang;
document.getElementById('langSel').onchange = function() {
  selectedLang = this.value;
  localStorage.setItem("tractorLang", selectedLang);
  renderTexts();
  loadLogs();
};

renderTexts();
</script>
</body>
</html>